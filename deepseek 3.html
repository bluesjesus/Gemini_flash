<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gemini AI Chatbot</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <style>
    :root {
      --primary: #4361ee;
      --primary-dark: #3a56d4;
      --secondary: #7209b7;
      --text-primary: #1a1a1a;
      --text-secondary: #4a4a4a;
      --background: #ffffff;
      --background-secondary: #f5f7fb;
      --user-bubble: #e7f1ff;
      --bot-bubble: #f0f4ff;
      --sidebar-bg: #202123;
      --sidebar-text: #ececf1;
      --sidebar-hover: #343541;
      --success: #4caf50;
      --error: #f44336;
      --shadow-sm: 0 2px 8px rgba(0,0,0,0.08);
      --shadow-md: 0 4px 16px rgba(0,0,0,0.12);
      --radius-sm: 8px;
      --radius-md: 12px;
      --radius-lg: 16px;
      --transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
      -webkit-user-select: none;
      user-select: none;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--background);
      color: var(--text-primary);
      height: 100vh;
      overflow: hidden;
      position: relative;
      touch-action: manipulation;
    }

    #app {
      display: flex;
      height: 100%;
      width: 100%;
      overflow: hidden;
    }

    /* Sidebar */
    #sidebar {
      width: 280px;
      background: var(--sidebar-bg);
      color: var(--sidebar-text);
      display: flex;
      flex-direction: column;
      transition: var(--transition);
      z-index: 100;
      box-shadow: var(--shadow-md);
    }

    .sidebar-header {
      padding: 20px 16px;
      border-bottom: 1px solid #333;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 1.4rem;
      font-weight: 700;
    }

    .logo i {
      color: var(--primary);
      background: white;
      border-radius: 6px;
      padding: 3px;
    }

    #user-info {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px 16px;
      gap: 12px;
      border-bottom: 1px solid #333;
    }

    #user-avatar {
      width: 56px;
      height: 56px;
      border-radius: 50%;
      background: #3a56d4;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      font-weight: 600;
      color: white;
    }

    #user-name {
      font-weight: 600;
      font-size: 1.1rem;
    }

    .sidebar-actions {
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .btn {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 12px 16px;
      border-radius: var(--radius-sm);
      background: var(--primary);
      color: white;
      font-weight: 500;
      border: none;
      cursor: pointer;
      transition: var(--transition);
      font-size: 1rem;
    }

    .btn:hover {
      background: var(--primary-dark);
    }

    .btn.outline {
      background: transparent;
      border: 1px solid #555;
      color: var(--sidebar-text);
    }

    .btn.outline:hover {
      background: var(--sidebar-hover);
    }

    #chat-history {
      flex: 1;
      overflow-y: auto;
      padding: 0 8px;
    }

    .chat-item {
      padding: 12px 14px;
      border-radius: var(--radius-sm);
      margin-bottom: 4px;
      cursor: pointer;
      transition: var(--transition);
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 0.95rem;
      color: #d1d5db;
    }

    .chat-item i {
      font-size: 1.1rem;
      color: #9ca3af;
    }

    .chat-item:hover, .chat-item.active {
      background: var(--sidebar-hover);
    }

    /* Main Chat Area */
    #main {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: var(--background-secondary);
    }

    #chat-header {
      padding: 16px 24px;
      display: flex;
      align-items: center;
      background: white;
      box-shadow: var(--shadow-sm);
      z-index: 10;
    }

    #menu-btn {
      background: none;
      border: none;
      font-size: 1.4rem;
      color: var(--text-secondary);
      cursor: pointer;
      display: none;
      margin-right: 16px;
    }

    #chat-title {
      font-weight: 600;
      font-size: 1.2rem;
    }

    #chat-area {
      flex: 1;
      overflow-y: auto;
      padding: 24px;
      display: flex;
      flex-direction: column;
      gap: 24px;
      scroll-behavior: smooth;
    }

    .message {
      display: flex;
      gap: 16px;
      max-width: 800px;
      margin: 0 auto;
      width: 100%;
      animation: fadeIn 0.3s ease;
    }

    .avatar {
      width: 36px;
      height: 36px;
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      font-weight: 600;
    }

    .user .avatar {
      background: var(--primary);
      color: white;
    }

    .bot .avatar {
      background: var(--secondary);
      color: white;
    }

    .bubble {
      padding: 16px 20px;
      border-radius: var(--radius-md);
      line-height: 1.6;
      font-size: 1.05rem;
      box-shadow: var(--shadow-sm);
      animation: scaleIn 0.25s ease;
      color: var(--text-primary);
      word-break: break-word;
      white-space: pre-wrap;
    }

    .user .bubble {
      background: var(--user-bubble);
      border-top-right-radius: var(--radius-sm);
    }

    .bot .bubble {
      background: var(--bot-bubble);
      border-top-left-radius: var(--radius-sm);
    }

    .typing-indicator {
      display: flex;
      gap: 6px;
      padding: 10px 0;
    }

    .typing-dot {
      width: 8px;
      height: 8px;
      background: var(--text-secondary);
      border-radius: 50%;
      animation: bounce 1.5s infinite ease-in-out;
    }

    .typing-dot:nth-child(2) {
      animation-delay: 0.2s;
    }

    .typing-dot:nth-child(3) {
      animation-delay: 0.4s;
    }

    /* Input Area */
    #input-area {
      padding: 20px 24px;
      background: white;
      border-top: 1px solid #e5e7eb;
    }

    .input-container {
      max-width: 800px;
      margin: 0 auto;
      display: flex;
      gap: 12px;
      position: relative;
      align-items: flex-end;
    }

    .icon-btn {
      width: 42px;
      height: 42px;
      border-radius: 50%;
      background: transparent;
      color: var(--text-secondary);
      border: none;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: var(--transition);
      flex-shrink: 0;
      font-size: 1.2rem;
    }

    .icon-btn:hover {
      background: #f0f0f0;
    }

    #message-input {
      flex: 1;
      padding: 16px 20px;
      border-radius: var(--radius-lg);
      border: 1px solid #e5e7eb;
      font-size: 1.05rem;
      background: var(--background);
      color: var(--text-primary);
      resize: none;
      max-height: 150px;
      transition: var(--transition);
      font-family: inherit;
    }

    #message-input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.15);
    }

    #send-btn {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      background: var(--primary);
      color: white;
      border: none;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: var(--transition);
      flex-shrink: 0;
      font-size: 1.2rem;
    }

    #send-btn:hover {
      background: var(--primary-dark);
    }

    #send-btn:disabled {
      background: #c5c5c5;
      cursor: not-allowed;
    }

    /* Mobile Sidebar */
    #sidebar-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 90;
      display: none;
      transition: var(--transition);
    }

    /* Animations */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @keyframes scaleIn {
      from { transform: scale(0.95); opacity: 0; }
      to { transform: scale(1); opacity: 1; }
    }

    @keyframes bounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-5px); }
    }

    /* Responsive Design */
    @media (max-width: 900px) {
      #sidebar {
        position: fixed;
        left: 0;
        top: 0;
        bottom: 0;
        transform: translateX(-100%);
      }
      
      #sidebar.open {
        transform: translateX(0);
      }
      
      #menu-btn {
        display: block;
      }
      
      .sidebar-open #sidebar-overlay {
        display: block;
      }
    }

    @media (max-width: 600px) {
      #chat-area {
        padding: 16px;
      }
      
      .message {
        gap: 12px;
      }
      
      .avatar {
        width: 32px;
        height: 32px;
        font-size: 0.9rem;
      }
      
      .bubble {
        padding: 14px 18px;
        font-size: 1rem;
      }
      
      #input-area {
        padding: 16px;
      }
      
      #message-input {
        padding: 14px 18px;
      }
      
      .icon-btn {
        width: 36px;
        height: 36px;
        font-size: 1rem;
      }
      
      #send-btn {
        width: 42px;
        height: 42px;
        font-size: 1.1rem;
      }
    }

    /* Utility Classes */
    .hidden {
      display: none !important;
    }

    /* Scrollbar styling */
    ::-webkit-scrollbar {
      width: 6px;
    }

    ::-webkit-scrollbar-track {
      background: transparent;
    }

    ::-webkit-scrollbar-thumb {
      background: #c5c5c5;
      border-radius: 3px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: #a0a0a0;
    }
  </style>
</head>
<body>
  <div id="app">
    <!-- Sidebar -->
    <aside id="sidebar">
      <div class="sidebar-header">
        <div class="logo">
          <i class="fas fa-gem"></i>
          <span>Gemini AI</span>
        </div>
      </div>
      
      <div id="user-info">
        <div id="user-avatar">G</div>
        <div id="user-name">Guest</div>
      </div>
      
      <div class="sidebar-actions">
        <button id="new-chat-btn" class="btn">
          <i class="fas fa-plus"></i>
          New Chat
        </button>
        <button id="login-btn" class="btn outline">
          <i class="fas fa-sign-in-alt"></i>
          Sign In
        </button>
        <button id="logout-btn" class="btn outline hidden">
          <i class="fas fa-sign-out-alt"></i>
          Sign Out
        </button>
      </div>
      
      <div id="chat-history">
        <!-- Chat history will be populated dynamically -->
      </div>
    </aside>
    
    <div id="sidebar-overlay"></div>
    
    <!-- Main Chat Area -->
    <main id="main">
      <header id="chat-header">
        <button id="menu-btn">
          <i class="fas fa-bars"></i>
        </button>
        <h1 id="chat-title">Gemini AI Assistant</h1>
      </header>
      
      <section id="chat-area">
        <div class="message bot">
          <div class="avatar">G</div>
          <div class="bubble">
            <h3>Welcome to Gemini AI!</h3>
            <p>I'm your AI assistant powered by Google's Gemini technology. How can I help you today?</p>
            <p>You can ask me anything - I'm here to assist with information, ideas, and creative tasks!</p>
          </div>
        </div>
      </section>
      
      <footer id="input-area">
        <div class="input-container">
          <button id="send-btn" class="icon-btn" disabled>
            <i class="fas fa-paper-plane"></i>
          </button>
          <textarea 
            id="message-input" 
            placeholder="Message Gemini..." 
            rows="1"
            autocomplete="off"
          ></textarea>
        </div>
      </footer>
    </main>
  </div>

  <script>
    // Firebase Configuration
    const firebaseConfig = {
      apiKey: "AIzaSyDDdaUMgPSmlkRfjaBDm9SrylWyX7wC2oE",
      authDomain: "ai-chatbot-b38da.firebaseapp.com",
      projectId: "ai-chatbot-b38da",
      storageBucket: "ai-chatbot-b38da.appspot.com",
      messagingSenderId: "502343320611",
      appId: "1:502343320611:web:247b096133faf46688dd96",
      measurementId: "G-C41SD3CCJ2"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // DOM Elements
    const app = document.getElementById('app');
    const sidebar = document.getElementById('sidebar');
    const sidebarOverlay = document.getElementById('sidebar-overlay');
    const menuBtn = document.getElementById('menu-btn');
    const userAvatar = document.getElementById('user-avatar');
    const userNameEl = document.getElementById('user-name');
    const loginBtn = document.getElementById('login-btn');
    const logoutBtn = document.getElementById('logout-btn');
    const newChatBtn = document.getElementById('new-chat-btn');
    const chatHistory = document.getElementById('chat-history');
    const chatArea = document.getElementById('chat-area');
    const chatTitle = document.getElementById('chat-title');
    const messageInput = document.getElementById('message-input');
    const sendBtn = document.getElementById('send-btn');

    // State variables
    let userId = null;
    let userName = "Guest";
    let chats = [];
    let currentChatId = null;
    let currentMessages = [];
    let touchStartX = 0;
    let touchCurrentX = 0;
    let isSidebarOpen = false;

    // Initialize the app
    function init() {
      setupEventListeners();
      setupFirebaseAuth();
      setupSwipeGestures();
      autoResizeTextarea();
      window.dispatchEvent(new Event('resize'));
    }

    // Set up event listeners
    function setupEventListeners() {
      // Toggle sidebar
      menuBtn.addEventListener('click', toggleSidebar);
      sidebarOverlay.addEventListener('click', closeSidebar);
      
      // Authentication
      loginBtn.addEventListener('click', signIn);
      logoutBtn.addEventListener('click', signOut);
      
      // Chat actions
      newChatBtn.addEventListener('click', startNewChat);
      sendBtn.addEventListener('click', sendMessage);
      
      // Message input
      messageInput.addEventListener('input', () => {
        sendBtn.disabled = !messageInput.value.trim();
      });
      
      messageInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          if (messageInput.value.trim() && !sendBtn.disabled) {
            sendMessage();
          }
        }
      });
      
      // Window resize
      window.addEventListener('resize', handleResize);
    }

    // Setup Firebase authentication
    function setupFirebaseAuth() {
      auth.onAuthStateChanged(user => {
        if (user) {
          // User is signed in
          userId = user.uid;
          userName = user.displayName || user.email || "User";
          userNameEl.textContent = userName;
          userAvatar.textContent = userName.charAt(0).toUpperCase();
          loginBtn.classList.add('hidden');
          logoutBtn.classList.remove('hidden');
          loadChats();
        } else {
          // User is signed out
          userId = null;
          userName = "Guest";
          userNameEl.textContent = userName;
          userAvatar.textContent = "G";
          loginBtn.classList.remove('hidden');
          logoutBtn.classList.add('hidden');
          chatHistory.innerHTML = "";
          currentChatId = null;
          chats = [];
          currentMessages = [];
          startNewChat();
        }
      });
    }

    // Toggle sidebar
    function toggleSidebar() {
      isSidebarOpen = !isSidebarOpen;
      sidebar.classList.toggle('open', isSidebarOpen);
      sidebarOverlay.style.display = isSidebarOpen ? 'block' : 'none';
      app.classList.toggle('sidebar-open', isSidebarOpen);
    }

    function closeSidebar() {
      isSidebarOpen = false;
      sidebar.classList.remove('open');
      sidebarOverlay.style.display = 'none';
      app.classList.remove('sidebar-open');
    }

    // Handle window resize
    function handleResize() {
      if (window.innerWidth > 900) {
        sidebarOverlay.style.display = 'none';
        sidebar.classList.remove('open');
        app.classList.remove('sidebar-open');
        menuBtn.style.display = 'none';
      } else {
        menuBtn.style.display = 'block';
      }
    }

    // Setup swipe gestures for mobile
    function setupSwipeGestures() {
      document.addEventListener('touchstart', (e) => {
        if (e.touches[0].clientX < 30 && !isSidebarOpen) {
          touchStartX = e.touches[0].clientX;
        } else {
          touchStartX = 0;
        }
      });

      document.addEventListener('touchmove', (e) => {
        if (!touchStartX) return;
        touchCurrentX = e.touches[0].clientX;
        const deltaX = touchCurrentX - touchStartX;
        if (deltaX > 0 && deltaX < sidebar.offsetWidth + 30) {
          sidebar.style.transition = 'none';
          sidebar.style.transform = `translateX(${-sidebar.offsetWidth + deltaX}px)`;
        }
      });

      document.addEventListener('touchend', () => {
        if (!touchStartX) return;
        sidebar.style.transition = '';
        sidebar.style.transform = '';
        const deltaX = touchCurrentX - touchStartX;
        if (deltaX > 60) {
          toggleSidebar();
        }
        touchStartX = 0;
      });
    }

    // Auto-resize textarea
    function autoResizeTextarea() {
      messageInput.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = (this.scrollHeight) + 'px';
      });
    }

    // Sign in with Google
    function signIn() {
      auth.signInWithPopup(new firebase.auth.GoogleAuthProvider())
        .catch(error => {
          console.error("Sign in error:", error);
          showNotification("Failed to sign in. Please try again.", "error");
        });
    }

    // Sign out
    function signOut() {
      auth.signOut()
        .then(() => {
          showNotification("Signed out successfully", "success");
          startNewChat();
        })
        .catch(error => {
          console.error("Sign out error:", error);
          showNotification("Failed to sign out. Please try again.", "error");
        });
    }

    // Load user's chat history
    function loadChats() {
      if (!userId) return;
      
      db.collection('users').doc(userId).collection('chats')
        .orderBy('updatedAt', 'desc')
        .onSnapshot(snapshot => {
          chats = [];
          chatHistory.innerHTML = "";
          
          snapshot.forEach(doc => {
            const chat = { id: doc.id, ...doc.data() };
            chats.push(chat);
            
            const chatItem = document.createElement('div');
            chatItem.className = 'chat-item';
            if (chat.id === currentChatId) chatItem.classList.add('active');
            
            chatItem.innerHTML = `
              <i class="fas fa-comment"></i>
              <span>${chat.title || "New Chat"}</span>
            `;
            
            chatItem.addEventListener('click', () => {
              currentChatId = chat.id;
              loadMessages();
              closeSidebar();
              // Update active state
              document.querySelectorAll('.chat-item').forEach(item => item.classList.remove('active'));
              chatItem.classList.add('active');
            });
            
            chatHistory.appendChild(chatItem);
          });
          
          if (!currentChatId && chats.length > 0) {
            currentChatId = chats[0].id;
            loadMessages();
          }
        }, error => {
          console.error("Error loading chats:", error);
          showNotification("Failed to load chat history", "error");
        });
    }

    // Load messages for the current chat
    function loadMessages() {
      if (!currentChatId || !userId) return;
      
      chatArea.innerHTML = "";
      currentMessages = [];
      
      db.collection('users').doc(userId).collection('chats').doc(currentChatId)
        .collection('messages')
        .orderBy('timestamp')
        .onSnapshot(snapshot => {
          snapshot.forEach(doc => {
            const msg = doc.data();
            // Avoid duplicate messages
            if (!currentMessages.some(m => m.id === doc.id)) {
              currentMessages.push({...msg, id: doc.id});
              renderMessage(msg);
            }
          });
          
          // Scroll to bottom
          chatArea.scrollTop = chatArea.scrollHeight;
          
          // Update chat title
          const currentChat = chats.find(c => c.id === currentChatId);
          chatTitle.textContent = currentChat?.title || "New Chat";
        }, error => {
          console.error("Error loading messages:", error);
          showNotification("Failed to load messages", "error");
        });
    }

    // Render a message in the chat area
    function renderMessage(msg) {
      const messageDiv = document.createElement('div');
      messageDiv.className = `message ${msg.sender}`;
      
      messageDiv.innerHTML = `
        <div class="avatar">${msg.sender === 'user' ? userName.charAt(0).toUpperCase() : 'G'}</div>
        <div class="bubble">${msg.text}</div>
      `;
      
      chatArea.appendChild(messageDiv);
      chatArea.scrollTop = chatArea.scrollHeight;
    }

    // Start a new chat
    function startNewChat() {
      currentChatId = null;
      currentMessages = [];
      chatArea.innerHTML = `
        <div class="message bot">
          <div class="avatar">G</div>
          <div class="bubble">
            <h3>New Chat Started</h3>
            <p>I'm your AI assistant. How can I help you today?</p>
          </div>
        </div>
      `;
      messageInput.value = '';
      messageInput.style.height = 'auto';
      sendBtn.disabled = true;
      chatTitle.textContent = "Gemini AI Assistant";
      
      // Remove active state from chat items
      document.querySelectorAll('.chat-item').forEach(item => item.classList.remove('active'));
    }

    // Send a message
    async function sendMessage() {
      const text = messageInput.value.trim();
      if (!text || !userId) return;
      
      sendBtn.disabled = true;
      
      try {
        // Create a new chat if needed
        if (!currentChatId) {
          const chatRef = await db.collection('users').doc(userId).collection('chats').add({
            title: text.length > 50 ? text.substring(0, 47) + '...' : text,
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
          });
          currentChatId = chatRef.id;
        } else {
          await db.collection('users').doc(userId).collection('chats').doc(currentChatId)
            .update({ updatedAt: firebase.firestore.FieldValue.serverTimestamp() });
        }
        
        // Add user message
        await db.collection('users').doc(userId).collection('chats').doc(currentChatId)
          .collection('messages').add({
            text: text,
            sender: 'user',
            timestamp: firebase.firestore.FieldValue.serverTimestamp(),
            type: 'text'
          });
        
        messageInput.value = '';
        messageInput.style.height = 'auto';
        sendBtn.disabled = true;
        
        // Show typing indicator
        showTypingIndicator();
        
        // Get AI response
        getAIResponse();
      } catch (error) {
        console.error("Error sending message:", error);
        showNotification("Failed to send message. Please try again.", "error");
        sendBtn.disabled = false;
      }
    }

    // Show typing indicator
    function showTypingIndicator() {
      const typingDiv = document.createElement('div');
      typingDiv.className = 'message bot typing';
      
      typingDiv.innerHTML = `
        <div class="avatar">G</div>
        <div class="bubble">
          <div class="typing-indicator">
            <div class="typing-dot"></div>
            <div class="typing-dot"></div>
            <div class="typing-dot"></div>
          </div>
        </div>
      `;
      
      chatArea.appendChild(typingDiv);
      chatArea.scrollTop = chatArea.scrollHeight;
    }

    // Remove typing indicator
    function removeTypingIndicator() {
      const typingIndicator = document.querySelector('.message.typing');
      if (typingIndicator) {
        typingIndicator.remove();
      }
    }

    // Get AI response from Gemini via Vercel
    async function getAIResponse() {
      if (!currentChatId || !userId) return;
      
      try {
        // Format messages for Gemini API
        const messages = currentMessages.map(msg => ({
          role: msg.sender === 'user' ? 'user' : 'model',
          parts: [{ text: msg.text }]
        }));
        
        // Get the most recent messages (last 10)
        const recentMessages = messages.slice(-10);
        
        // Call Gemini API via Vercel proxy
        const response = await fetch('https://gemini-chat-proxy.vercel.app/api/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            messages: recentMessages,
            userId: userId,
            chatId: currentChatId
          })
        });
        
        if (!response.ok) {
          throw new Error(`Server responded with ${response.status}`);
        }
        
        const data = await response.json();
        const botResponse = data.text;
        
        // Add bot response to Firestore
        await db.collection('users').doc(userId).collection('chats').doc(currentChatId)
          .collection('messages').add({
            text: botResponse,
            sender: 'bot',
            timestamp: firebase.firestore.FieldValue.serverTimestamp(),
            type: 'text'
          });
        
      } catch (error) {
        console.error("Error getting AI response:", error);
        
        // Add error message to chat
        await db.collection('users').doc(userId).collection('chats').doc(currentChatId)
          .collection('messages').add({
            text: "I'm having trouble connecting right now. Please try again later.",
            sender: 'bot',
            timestamp: firebase.firestore.FieldValue.serverTimestamp(),
            type: 'text'
          });
      } finally {
        removeTypingIndicator();
      }
    }

    // Show notification
    function showNotification(message, type = "info") {
      // Create notification element
      const notification = document.createElement('div');
      notification.className = `notification ${type}`;
      notification.textContent = message;
      document.body.appendChild(notification);
      
      // Auto remove after 3 seconds
      setTimeout(() => {
        notification.remove();
      }, 3000);
    }

    // Initialize the app when DOM is loaded
    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>